<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ß–µ–ª–ª–µ–Ω–¥–∂</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f1f1f1;
    }
    .tabs {
      display: flex;
      justify-content: space-around;
      background: #333;
      color: white;
    }
    .tabs button {
      flex: 1;
      padding: 12px;
      background: #333;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    .tabs button.active {
      background: #4caf50;
    }
    .tab-content {
      display: none;
      padding: 20px;
    }
    .tab-content.active {
      display: block;
    }
    .block {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin: 10px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 6px 0 12px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
    }
    button {
      background: #4caf50;
      color: white;
      font-weight: bold;
      border: none;
    }
    .stats {
      font-size: 16px;
      margin: 6px 0;
    }
    .progress-bar {
      height: 24px;
      background: #ddd;
      border-radius: 12px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-fill {
      height: 100%;
      background: #4caf50;
      text-align: center;
      color: white;
      line-height: 24px;
    }
  </style>
  <div id="startScreen" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #f4f4f4;">
    <h2>–ß–µ–ª–ª–µ–Ω–¥–∂</h2>
    <button onclick="startApp()" style="padding: 20px 40px; font-size: 20px; border-radius: 30px; background: #4caf50; color: white; border: none;">üöÄ –°–¢–ê–†–¢</button>
  </div>

</head>
<body>

<div class="tabs style="display:none;"">
  <button class="tab-btn active" onclick="openTab(0)">üèÅ</button>
  <button class="tab-btn" onclick="openTab(1)">üõ† –ü–ª–∞–Ω</button>
  <button class="tab-btn" onclick="openTab(2)">üìÖ –ò—Å—Ç–æ—Ä–∏—è</button>
  <button class="tab-btn" onclick="openTab(3)">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
</div>

<div id="tab-0" class="tab-content active">
  <div class="block">
    <h3>–ß–µ–ª–ª–µ–Ω–¥–∂ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è!</h3>
    <p>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ —á–µ–ª–ª–µ–Ω–¥–∂—É ‚Äî —à–∞–≥ –∑–∞ —à–∞–≥–æ–º —Ç—ã –Ω–µ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–∏—à—å —Å–µ–±—è, –Ω–æ –∏ —É–∫—Ä–µ–ø–∏—à—å –∑–¥–æ—Ä–æ–≤—å–µ. –í—Å—ë –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–µ–≥–æ–¥–Ω—è.</p>
    <button onclick="openTab(1)">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–ª–∞–Ω</button>
    <button onclick="openTab(2)">–û—Ç–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    <button onclick="openTab(3)">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
  </div>
</div>
<div id="tab-1" class="tab-content">
  <div class="block" id="planDisplay" style="display: none;">
    <h3>–í–∞—à —Ç–µ–∫—É—â–∏–π –ø–ª–∞–Ω</h3>
    <div id="planDetails"></div>
    <button onclick="editPlan()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    <button onclick="resetPlan()">‚ùå –°–±—Ä–æ—Å–∏—Ç—å –ø–ª–∞–Ω</button>
    <button onclick="showPlanHistory()">üìú –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—à–ª—ã—Ö</button>
  </div>

  <div class="block" id="planForm" style="display: none;">
    <h3 id="planFormTitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞–Ω–∞</h3>
    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π:</label>
    <input type="number" id="days" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 30">
    <label>–®–∞–≥–æ–≤ –≤ –¥–µ–Ω—å:</label>
    <input type="number" id="stepGoal" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 8000">
    <label>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –Ω–µ–¥–µ–ª—é:</label>
    <input type="number" id="workouts" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 3">
    <button onclick="savePlan()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <div id="planSaved"></div>
  </div>
</div>
<script>
  async function loadPlan() {
    const { data } = await supabase
      .from('plan')
      .select('*')
      .eq('user_id', userId)
      .eq('is_active', true)
      .single();

    if (data) {
      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –±–ª–æ–∫ –ø–ª–∞–Ω–∞
      document.getElementById("planDisplay").style.display = "block";
      document.getElementById("planForm").style.display = "none";
      document.getElementById("planDetails").innerHTML = `
        üóì –î–Ω–µ–π: ${data.days}<br>
        üö∂‚Äç‚ôÇÔ∏è –®–∞–≥–æ–≤ –≤ –¥–µ–Ω—å: ${data.step_goal}<br>
        üèãÔ∏è‚Äç‚ôÄÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –Ω–µ–¥–µ–ª—é: ${data.workout_per_week}
      `;
    } else {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
      document.getElementById("planForm").style.display = "block";
      document.getElementById("planDisplay").style.display = "none";
    }
  }

  async function savePlan() {
    const days = parseInt(document.getElementById('days').value);
    const stepGoal = parseInt(document.getElementById('stepGoal').value);
    const workouts = parseInt(document.getElementById('workouts').value);

    // –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–Ω—ã
    await supabase.from('plan').update({ is_active: false }).eq('user_id', userId);

    const { error } = await supabase.from('plan').insert({
      user_id: userId,
      days,
      step_goal: stepGoal,
      workout_per_week: workouts,
      is_active: true
    });

    document.getElementById("planSaved").innerText = error ? "–û—à–∏–±–∫–∞: " + error.message : "‚úÖ –ü–ª–∞–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω!";
    loadPlan();
  }

  function editPlan() {
    document.getElementById("planForm").style.display = "block";
    document.getElementById("planDisplay").style.display = "none";
  }

  async function resetPlan() {
    const confirmed = confirm("–°–±—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø–ª–∞–Ω –∏ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?");
    if (!confirmed) return;

    await supabase.from('plan').update({ is_active: false }).eq('user_id', userId).eq('is_active', true);
    await supabase.from('activity').delete().eq('user_id', userId);
    loadPlan();
  }

  function showPlanHistory() {
    alert("–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—à–ª—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ!");
  }

  loadPlan();
</script>
<div id="tab-2" class="tab-content">
  <div class="block">
    <h3>–ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è + —Ñ–æ—Ä–º–∞ -->
    <div style="margin-bottom: 15px;">
      <button onclick="showAddDayForm()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–µ–Ω—å</button>
      <div id="addDayForm" style="display:none; margin-top: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 10px; background: #f9f9f9;">
        <h4>–î–æ–±–∞–≤–∏—Ç—å –¥–µ–Ω—å</h4>
        <label>–î–∞—Ç–∞:</label>
        <input type="date" id="inputDate"><br>
        <label>–®–∞–≥–æ–≤:</label>
        <input type="number" id="inputSteps"><br>
        <label>–ë—ã–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞?</label>
        <select id="inputWorkout">
          <option value="yes">–î–∞</option>
          <option value="no">–ù–µ—Ç</option>
        </select><br><br>
        <button onclick="saveDayManual()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button onclick="hideAddDayForm()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è –¥–Ω–µ–π -->
    <div id="historyList"></div>
  </div>
</div>
<script>
  function showAddDayForm() {
    document.getElementById("addDayForm").style.display = "block";
  }

  function hideAddDayForm() {
    document.getElementById("addDayForm").style.display = "none";
  }

  async function saveDayManual() {
    const date = document.getElementById("inputDate").value;
    const steps = parseInt(document.getElementById("inputSteps").value);
    const workout = document.getElementById("inputWorkout").value === "yes";

    if (!date || isNaN(steps)) {
      alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.");
      return;
    }

    const { error } = await supabase.from("activity").insert({
      user_id: userId,
      date,
      steps,
      workout
    });

    if (error) {
      alert("–û—à–∏–±–∫–∞: " + error.message);
    } else {
      hideAddDayForm();
      loadHistory();
    }
  }

  async function loadHistory() {
    const { data, error } = await supabase
      .from("activity")
      .select("*")
      .eq("user_id", userId)
      .order("date", { ascending: false });

    if (error) {
      document.getElementById("historyList").innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.";
      return;
    }

    const container = document.getElementById("historyList");
    container.innerHTML = "";

    data.forEach(entry => {
      const div = document.createElement("div");
      div.style.marginBottom = "15px";
      div.style.padding = "10px";
      div.style.border = "1px solid #ddd";
      div.style.borderRadius = "10px";
      div.style.backgroundColor = "#ffffff";
      div.innerHTML = `
        üìÖ ${entry.date} ‚Äî ${entry.steps} —à–∞–≥–æ–≤, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: ${entry.workout ? "–¥–∞" : "–Ω–µ—Ç"}
        <br>
        <button onclick="deleteDay(${entry.id})" style="margin-top: 5px;">üóë –£–¥–∞–ª–∏—Ç—å</button>
      `;
      container.appendChild(div);
    });
  }

  async function deleteDay(id) {
    const confirmed = confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?");
    if (!confirmed) return;
    await supabase.from("activity").delete().eq("id", id);
    loadHistory();
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  loadHistory();
</script>
<div id="tab-3" class="tab-content">
  <div class="block">
    <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
    <div class="stats" id="summary"></div>
    <div class="progress-bar">
      <div id="progress-fill" class="progress-fill" style="width:0%">0%</div>
    </div>
  </div>
</div>
<script>
  const tabs = document.querySelectorAll(".tab-content");
  const buttons = document.querySelectorAll(".tab-btn");

  function openTab(i) {
    tabs.forEach((tab, index) => {
      tab.classList.toggle("active", index === i);
      buttons[index].classList.toggle("active", index === i);
    });
  }

  const tg = window.Telegram.WebApp;
function startApp() {
  document.getElementById("startScreen").style.display = "none";
  document.querySelector(".tabs").style.display = "flex";

  openTab(0); // –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é –≤–∫–ª–∞–¥–∫—É

  tg.ready(() => {
    window.userId = tg.initDataUnsafe?.user?.id || "guest";
    loadPlan();
    loadHistory();
    updateStats();
  });
}

  tg.ready(() => {
    const userId = tg.initDataUnsafe?.user?.id || "guest";

    window.userId = userId; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ

    loadPlan();
    loadHistory();
    updateStats();
  });

  const supabase = window.supabase.createClient(
    'https://dynbruywcezqdcokbyql.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5bmJydXl3Y2V6cWRjb2tieXFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0Mjc5MjYsImV4cCI6MjA2NDAwMzkyNn0.EB6MyFy8rBxB-1Kg6UONaovisyTsf_XlXSBPixoJScw'
  );

  async function saveDay() {
    const steps = parseInt(document.getElementById('steps').value);
    const workout = document.getElementById('workout').value;
    const today = new Date().toISOString().split('T')[0];

    const { error } = await supabase.from('activity').insert({
      date: today,
      steps: steps,
      workout: workout === 'yes',
      user_id: userId
    });

    document.getElementById('result').innerText = error ? "–û—à–∏–±–∫–∞: " + error.message : "–î–µ–Ω—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!";
    updateStats();
  }

  async function updateStats() {
    const { data } = await supabase.from('activity').select('*').eq('user_id', userId);
    if (!data) return;

    let points = 0;
    for (const day of data) {
      if (day.steps >= 8000) points += 1;
      if (day.workout) points += 1;
    }
    const percent = Math.round((points / 60) * 100);
    document.getElementById('summary').innerText = `–ù–∞–±—Ä–∞–Ω–æ –±–∞–ª–ª–æ–≤: ${points} –∏–∑ 60`;
    const bar = document.getElementById('progress-fill');
    bar.style.width = percent + '%';
    bar.innerText = percent + '%';
  }

  async function savePlan() {
    const days = document.getElementById('days').value;
    const steps = document.getElementById('stepGoal').value;
    const workouts = document.getElementById('workouts').value;

    const { error } = await supabase.from('plan').upsert({
      user_id: userId,
      days: days,
      step_goal: steps,
      workout_per_week: workouts
    });

    document.getElementById('planSaved').innerText = error ? "–û—à–∏–±–∫–∞: " + error.message : "–ü–ª–∞–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω!";
  }

  updateStats();
</script>
</body>
</html>
