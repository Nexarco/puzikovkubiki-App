<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–û—Ç –ø—É–∑–∏–∫–∞ –∫ –∫—É–±–∏–∫–∞–º</title>

  <!-- Supabase –∏ Telegram SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- –°—Ç–∏–ª–∏ -->
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(to bottom, #0d0d0d, #1a1a2e);
      color: #fff;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      text-align: center;
      padding: 20px 10px 10px;
    }

    header img {
      width: 100px;
      border-radius: 50%;
      margin-bottom: 10px;
    }

    header h1 {
      font-size: 18px;
      margin: 0;
      font-weight: 600;
      color: #f0f0f0;
      letter-spacing: 0.5px;
    }

    .content {
      flex-grow: 1;
      padding: 15px;
    }

    .tab {
      display: none;
    }

    .tab.active {
      display: block;
    }

    .tabs-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #121212;
      border-top: 1px solid #2e2e2e;
      display: flex;
      justify-content: space-around;
      z-index: 100;
    }

    .tabs-nav button {
      flex: 1;
      padding: 10px 0 6px;
      font-size: 14px;
      background: none;
      color: #aaa;
      border: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .tabs-nav button.active {
      color: #4caf50;
    }

    .card {
      background: #1f1f1f;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
      margin-bottom: 20px;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      box-sizing: border-box;
    }

    input, select {
      background: #2e2e2e;
      color: #fff;
    }

    button {
      background-color: #4caf50;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://raw.githubusercontent.com/Nexarco/files/main/gym_logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø" />
    <h1>–û—Ç –ø—É–∑–∏–∫–∞ –∫ –∫—É–±–∏–∫–∞–º</h1>
  </header>

  <div class="content">
    <!-- üèÅ –í–∫–ª–∞–¥–∫–∞ 1 ‚Äî –ú–æ—Ç–∏–≤–∞—Ü–∏—è -->
    <div class="tab active" id="tab-0">
      <div class="card">
        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
        <p>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ —á–µ–ª–ª–µ–Ω–¥–∂—É ‚Äî —à–∞–≥ –∑–∞ —à–∞–≥–æ–º —Ç—ã –Ω–µ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–∏—à—å —Å–µ–±—è, –Ω–æ –∏ —É–∫—Ä–µ–ø–∏—à—å –∑–¥–æ—Ä–æ–≤—å–µ. –í—Å—ë –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–µ–≥–æ–¥–Ω—è.</p>
        <button onclick="switchTab(1)">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–ª–∞–Ω</button>
        <button onclick="switchTab(2)">–û—Ç–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        <button onclick="switchTab(3)">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
      </div>
    </div>

    <!-- üõ† –í–∫–ª–∞–¥–∫–∞ 2 ‚Äî –ü–ª–∞–Ω -->
    <div class="tab" id="tab-1">
      <div class="card">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞–Ω–∞</h2>
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π:</label>
        <input type="number" id="plan-days" placeholder="30">

        <label>–®–∞–≥–æ–≤ –≤ –¥–µ–Ω—å:</label>
        <input type="number" id="plan-steps" placeholder="8000">

        <label>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –Ω–µ–¥–µ–ª—é:</label>
        <input type="number" id="plan-workouts" placeholder="3">

        <button onclick="savePlan()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞–Ω</button>
        <div id="plan-message"></div>
      </div>
    </div>

    <!-- üìÖ –í–∫–ª–∞–¥–∫–∞ 3 ‚Äî –ò—Å—Ç–æ—Ä–∏—è -->
    <div class="tab" id="tab-2">
      <div class="card">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>
        <label>–®–∞–≥–æ–≤ –∑–∞ –¥–µ–Ω—å:</label>
        <input type="number" id="history-steps">

        <label>–ë—ã–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞?</label>
        <select id="history-workout">
          <option value="no">–ù–µ—Ç</option>
          <option value="yes">–î–∞</option>
        </select>

        <button onclick="saveActivity()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–µ–Ω—å</button>
        <div id="history-message"></div>
      </div>

      <div class="card">
        <h3>–ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
        <ul id="history-list" style="padding-left: 16px; list-style: none;"></ul>
      </div>
    </div>

    <!-- üìä –í–∫–ª–∞–¥–∫–∞ 4 ‚Äî –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="tab" id="tab-3">
      <div class="card">
        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <div id="stat-summary">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div style="margin-top: 16px;">
          <canvas id="progress-canvas" width="300" height="120" style="background: #000; border-radius: 8px;"></canvas>
        </div>
      </div>
    </div>
  </div> <!-- –∑–∞–∫—Ä—ã—Ç–∏–µ .content -->

  <!-- üîΩ –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è —Å –∏–∫–æ–Ω–∫–∞–º–∏ -->
  <div class="tabs-nav">
    <button class="tab-btn active" onclick="switchTab(0)">
      üèÅ
      <span style="font-size: 12px;">–ì–ª–∞–≤–Ω–∞—è</span>
    </button>
    <button class="tab-btn" onclick="switchTab(1)">
      üõ†
      <span style="font-size: 12px;">–ü–ª–∞–Ω</span>
    </button>
    <button class="tab-btn" onclick="switchTab(2)">
      üìÖ
      <span style="font-size: 12px;">–ò—Å—Ç–æ—Ä–∏—è</span>
    </button>
    <button class="tab-btn" onclick="switchTab(3)">
      üìä
      <span style="font-size: 12px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
    </button>
  </div>

  <!-- üîß JS -->
  <script>
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabs = document.querySelectorAll('.tab');

    function switchTab(index) {
      tabs.forEach((tab, i) => {
        tab.classList.toggle('active', i === index);
        tabButtons[i].classList.toggle('active', i === index);
      });
    }

    const tg = window.Telegram.WebApp;
    const userId = tg.initDataUnsafe?.user?.id || 'guest';

    const supabase = window.supabase.createClient(
      'https://dynbruywcezqdcokbyql.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5bmJydXl3Y2V6cWRjb2tieXFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0Mjc5MjYsImV4cCI6MjA2NDAwMzkyNn0.EB6MyFy8rBxB-1Kg6UONaovisyTsf_XlXSBPixoJScw'
    );
  // üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞–Ω
  async function savePlan() {
    const days = parseInt(document.getElementById("plan-days").value);
    const steps = parseInt(document.getElementById("plan-steps").value);
    const workouts = parseInt(document.getElementById("plan-workouts").value);

    if (!days || !steps || !workouts) {
      document.getElementById("plan-message").innerText = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.";
      return;
    }

    const { error } = await supabase.from("plan").upsert({
      user_id: userId,
      days,
      step_goal: steps,
      workout_per_week: workouts,
      is_active: true
    });

    document.getElementById("plan-message").innerText = error ? "–û—à–∏–±–∫–∞: " + error.message : "‚úÖ –ü–ª–∞–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω!";
  }

  // ‚ûï –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–µ–Ω—å
  async function saveActivity() {
    const steps = parseInt(document.getElementById("history-steps").value);
    const workout = document.getElementById("history-workout").value === "yes";
    const today = new Date().toISOString().split('T')[0];

    if (!steps) {
      document.getElementById("history-message").innerText = "–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤.";
      return;
    }

    const { error } = await supabase.from("activity").insert({
      user_id: userId,
      date: today,
      steps,
      workout
    });

    document.getElementById("history-message").innerText = error ? "–û—à–∏–±–∫–∞: " + error.message : "–î–µ–Ω—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!";
    loadHistory();
    renderStats();
  }

  // üìÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
  async function loadHistory() {
    const { data, error } = await supabase.from("activity")
      .select("*")
      .eq("user_id", userId)
      .order("date", { ascending: false });

    const list = document.getElementById("history-list");
    list.innerHTML = "";

    if (error) {
      list.innerHTML = "<li>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</li>";
      return;
    }

    data.forEach((item) => {
      const li = document.createElement("li");
      li.innerText = `üìÖ ${item.date}: ${item.steps} —à–∞–≥–æ–≤, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: ${item.workout ? "–¥–∞" : "–Ω–µ—Ç"}`;
      list.appendChild(li);
    });
  }

  // üìä –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ + –≥–æ—Ä–∞
  async function renderStats() {
    const { data } = await supabase.from("activity").select("*").eq("user_id", userId);
    if (!data) return;

    let points = 0;
    data.forEach((d) => {
      if (d.steps >= 8000) points++;
      if (d.workout) points++;
    });

    const percent = Math.round((points / 60) * 100);
    document.getElementById("stat-summary").innerText = `–ë–∞–ª–ª—ã: ${points} –∏–∑ 60 (${percent}%)`;

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ "–≥–æ—Ä—ã"
    const canvas = document.getElementById("progress-canvas");
    const ctx = canvas.getContext("2d");

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // —Ñ–æ–Ω
    ctx.fillStyle = "#1a1a2e";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // –≥–æ—Ä–∞
    ctx.beginPath();
    ctx.moveTo(0, canvas.height);
    ctx.lineTo(canvas.width * 0.2, canvas.height * 0.6);
    ctx.lineTo(canvas.width * 0.5, canvas.height * 0.3);
    ctx.lineTo(canvas.width * 0.8, canvas.height * 0.5);
    ctx.lineTo(canvas.width, canvas.height * 0.2);
    ctx.lineTo(canvas.width, canvas.height);
    ctx.closePath();
    ctx.fillStyle = "#4caf50";
    ctx.fill();

    // —á–µ–ª–æ–≤–µ—á–µ–∫
    const x = Math.min(canvas.width * (percent / 100), canvas.width - 20);
    const y = canvas.height - (percent / 100) * canvas.height * 0.7;

    ctx.font = "20px Arial";
    ctx.fillText("üèÉ", x, y);
  }

  // üöÄ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  loadHistory();
  renderStats();
</script>
</body>
</html>
