<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–û—Ç –ø—É–∑–∏–∫–∞ –∫ –∫—É–±–∏–∫–∞–º</title>

  <!-- Supabase –∏ Telegram SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(to bottom, #000000, #1f1f2e);
      color: #fff;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      text-align: center;
      padding: 20px 10px 10px;
    }

    header img {
      width: 100px;
      border-radius: 16px;
      margin-bottom: 10px;
    }

    header h1 {
      font-size: 20px;
      margin: 0;
      font-weight: 600;
      color: #f0f0f0;
      letter-spacing: 0.5px;
    }

    .content {
      flex-grow: 1;
      padding: 20px 14px 80px;
    }

    .tab {
      display: none;
    }

    .tab.active {
      display: block;
    }

    .tabs-nav {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      background: #1a1a1a;
      border-radius: 24px;
      box-shadow: 0 0 8px rgba(0, 255, 128, 0.2);
      display: flex;
      justify-content: space-between;
      padding: 6px 8px;
      z-index: 100;
    }

    .tabs-nav button {
      flex: 1;
      padding: 8px 0;
      font-size: 13px;
      background: none;
      color: #aaa;
      border: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      border-radius: 16px;
      transition: all 0.2s ease;
    }

    .tabs-nav button.active {
      background: #333;
      color: #4caf50;
    }

    .card {
      background: #1e1e1e;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      margin-bottom: 16px;
    }

    .card-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      background: #4caf50;
      color: white;
      padding: 10px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      flex: 1;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn:hover {
      background: #43a047;
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 10px;
      background: #2c2c2c;
      border: none;
      color: white;
      font-size: 14px;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    .activity-item {
      background: #2a2a2a;
      padding: 10px 14px;
      border-radius: 12px;
      margin-bottom: 12px;
    }

    .activity-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 8px;
    }

    .activity-buttons button {
      background: #444;
      border: none;
      color: #fff;
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .progress-bar {
      width: 100%;
      height: 22px;
      background: #2c2c2c;
      border-radius: 14px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #4caf50;
      text-align: center;
      line-height: 22px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://i.postimg.cc/GhZ9RQN5/logo-puziko.png" alt="–õ–æ–≥–æ—Ç–∏–ø" />
    <h1>–û—Ç –ø—É–∑–∏–∫–∞ –∫ –∫—É–±–∏–∫–∞–º</h1>
  </header>
  <div class="content">
    <!-- üèÅ –í–∫–ª–∞–¥–∫–∞ 1 ‚Äî –ì–ª–∞–≤–Ω–∞—è -->
    <div class="tab active" id="tab-0">
      <div class="card">
        <h2 style="text-align:center;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
        <p style="text-align:center;">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ —á–µ–ª–ª–µ–Ω–¥–∂—É ‚Äî —à–∞–≥ –∑–∞ —à–∞–≥–æ–º —Ç—ã –Ω–µ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–∏—à—å —Å–µ–±—è, –Ω–æ –∏ —É–∫—Ä–µ–ø–∏—à—å –∑–¥–æ—Ä–æ–≤—å–µ.</p>
        <div class="card-buttons">
          <button class="btn" onclick="switchTab(1)">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–ª–∞–Ω</button>
          <button class="btn" onclick="switchTab(2)">–û—Ç–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
          <button class="btn" onclick="switchTab(3)">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        </div>
      </div>
    </div>

    <!-- üõ† –í–∫–ª–∞–¥–∫–∞ 2 ‚Äî –ü–ª–∞–Ω -->
    <div class="tab" id="tab-1">
      <div id="plan-content"></div>
    </div>

    <!-- üìÖ –í–∫–ª–∞–¥–∫–∞ 3 ‚Äî –ò—Å—Ç–æ—Ä–∏—è -->
    <div class="tab" id="tab-2">
      <div class="card">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
        <label>–î–∞—Ç–∞:</label>
        <input type="date" id="act-date">

        <label>–®–∞–≥–æ–≤ –∑–∞ –¥–µ–Ω—å:</label>
        <input type="number" id="act-steps" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 8000">

        <label>–ë—ã–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞?</label>
        <select id="act-workout">
          <option value="no">–ù–µ—Ç</option>
          <option value="yes">–î–∞</option>
        </select>

        <button class="btn" onclick="saveActivity()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <div id="act-message"></div>
      </div>

      <div class="card">
        <h3>–ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
        <ul id="activity-list"></ul>
      </div>
    </div>

    <!-- üìä –í–∫–ª–∞–¥–∫–∞ 4 ‚Äî –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="tab" id="tab-3">
      <div class="card">
        <h3>–¢–µ–∫—É—â–∏–µ –±–∞–ª–ª—ã</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%">0%</div>
        </div>
        <p id="progress-text" style="margin-top: 10px; text-align:center;"></p>
      </div>
    </div>
  <!-- üîΩ –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è —Å –∏–∫–æ–Ω–∫–∞–º–∏ -->
  <div class="tabs-nav">
    <button class="tab-btn active" onclick="switchTab(0)">üèÅ<span style="font-size: 11px;">–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="tab-btn" onclick="switchTab(1)">üõ†<span style="font-size: 11px;">–ü–ª–∞–Ω</span></button>
    <button class="tab-btn" onclick="switchTab(2)">üìÖ<span style="font-size: 11px;">–ò—Å—Ç–æ—Ä–∏—è</span></button>
    <button class="tab-btn" onclick="switchTab(3)">üìä<span style="font-size: 11px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span></button>
  </div>

  <!-- JS -->
  <script>
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabs = document.querySelectorAll('.tab');

    function switchTab(index) {
      tabs.forEach((tab, i) => {
        tab.classList.toggle('active', i === index);
        tabButtons[i].classList.toggle('active', i === index);
      });
    }

    const tg = window.Telegram.WebApp;
    const userId = tg.initDataUnsafe?.user?.id || 'guest';

    const supabase = window.supabase.createClient(
      'https://dynbruywcezqdcokbyql.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5bmJydXl3Y2V6cWRjb2tieXFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0Mjc5MjYsImV4cCI6MjA2NDAwMzkyNn0.EB6MyFy8rBxB-1Kg6UONaovisyTsf_XlXSBPixoJScw'
    );
  </script>
<script>
  // üîÅ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–Ω–∞
  async function loadPlan() {
    const { data } = await supabase.from('plan').select('*').eq('user_id', userId).maybeSingle();
    const container = document.getElementById('plan-content');

    if (!data) {
      container.innerHTML = `
        <div class="card">
          <h3>–ù–∞—Å—Ç—Ä–æ–π —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –ø–ª–∞–Ω</h3>
          <button class="btn" onclick="showPlanForm()">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
        </div>
      `;
    } else {
      container.innerHTML = `
        <div class="card">
          <h3>–¢–µ–∫—É—â–∏–π –ø–ª–∞–Ω</h3>
          <p>üóì –î–Ω–µ–π: ${data.days}</p>
          <p>üö∂‚Äç‚ôÇÔ∏è –®–∞–≥–æ–≤ –≤ –¥–µ–Ω—å: ${data.step_goal}</p>
          <p>üèãÔ∏è‚Äç‚ôÇÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –Ω–µ–¥–µ–ª—é: ${data.workout_per_week}</p>
          <div class="card-buttons">
            <button class="btn" onclick="editPlan(${data.days}, ${data.step_goal}, ${data.workout_per_week})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω</button>
            <button class="btn" onclick="deletePlan()">–£–¥–∞–ª–∏—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</button>
          </div>
        </div>
      `;
    }
  }

  // ‚ûï –ü–æ–∫–∞–∑ —Ñ–æ—Ä–º—ã –Ω–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∞
  function showPlanForm(days = '', steps = '', workouts = '') {
    const container = document.getElementById('plan-content');
    container.innerHTML = `
      <div class="card">
        <h3>${days ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω' : '–ù–æ–≤—ã–π –ø–ª–∞–Ω'}</h3>
        <label>–î–Ω–µ–π:</label>
        <input type="number" id="plan-days" value="${days}">
        <label>–®–∞–≥–æ–≤ –≤ –¥–µ–Ω—å:</label>
        <input type="number" id="plan-steps" value="${steps}">
        <label>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –Ω–µ–¥–µ–ª—é:</label>
        <input type="number" id="plan-workouts" value="${workouts}">
        <div class="card-buttons">
          <button class="btn" onclick="savePlan()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" onclick="loadPlan()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    `;
  }

  async function editPlan(days, steps, workouts) {
    showPlanForm(days, steps, workouts);
  }

  async function savePlan() {
    const days = parseInt(document.getElementById("plan-days").value);
    const step_goal = parseInt(document.getElementById("plan-steps").value);
    const workout_per_week = parseInt(document.getElementById("plan-workouts").value);

    if (!days || !step_goal || !workout_per_week) return;

    await supabase.from('plan').upsert({ user_id: userId, days, step_goal, workout_per_week });
    loadPlan();
    renderStats();
  }

  async function deletePlan() {
    await supabase.from('plan').delete().eq('user_id', userId);
    await supabase.from('activity').delete().eq('user_id', userId);
    loadPlan();
    renderStats();
  }
</script>
<script>
  async function saveActivity() {
    const steps = parseInt(document.getElementById("act-steps").value);
    const workout = document.getElementById("act-workout").value === "yes";
    const date = document.getElementById("act-date").value;

    if (!steps || !date) {
      document.getElementById("act-message").innerText = "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ —à–∞–≥–∏.";
      return;
    }

    const { error } = await supabase.from("activity").upsert({
      user_id: userId,
      date,
      steps,
      workout
    });

    document.getElementById("act-message").innerText = error ? "–û—à–∏–±–∫–∞: " + error.message : "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!";
    renderHistory();
    renderStats();
  }

  async function renderHistory() {
    const { data } = await supabase.from("activity")
      .select("*")
      .eq("user_id", userId)
      .order("date", { ascending: false });

    const list = document.getElementById("activity-list");
    list.innerHTML = "";

    data.forEach(item => {
      const dateObj = new Date(item.date);
      const dateStr = dateObj.toLocaleDateString("ru-RU", {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });

      const li = document.createElement("li");
      li.className = "activity-item";
      li.innerHTML = `
        <div><b>${dateStr}</b></div>
        <div>–®–∞–≥–æ–≤: ${item.steps}</div>
        <div>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –±—ã–ª–∞: ${item.workout ? "–î–∞" : "–ù–µ—Ç"}</div>
        <div class="activity-buttons">
          <button onclick="deleteActivity('${item.date}')">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;
      list.appendChild(li);
    });
  }

  async function deleteActivity(date) {
    await supabase.from("activity").delete().eq("user_id", userId).eq("date", date);
    renderHistory();
    renderStats();
  }

  async function renderStats() {
    const { data } = await supabase.from("activity").select("*").eq("user_id", userId);
    const { data: plan } = await supabase.from("plan").select("*").eq("user_id", userId).maybeSingle();

    if (!data || !plan) return;

    let points = 0;
    data.forEach(d => {
      if (d.steps >= plan.step_goal) points++;
      if (d.workout) points++;
    });

    const maxPoints = plan.days * 2;
    const percent = Math.min(100, Math.round((points / maxPoints) * 100));

    document.getElementById("progress-fill").style.width = percent + "%";
    document.getElementById("progress-fill").innerText = percent + "%";
    document.getElementById("progress-text").innerText = `–¢–µ–∫—É—â–∏–µ –±–∞–ª–ª—ã: ${points} –∏–∑ ${maxPoints}`;
  }

  // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  loadPlan();
  renderHistory();
  renderStats();
</script>
</body>
</html>
